package com.clinica.cadastro.domain.service;

import java.util.List;

import org.springframework.stereotype.Service;

import com.clinica.cadastro.domain.exception.EntityNotFoundException;
import com.clinica.cadastro.domain.exception.UserNotDoctorExeption;
import com.clinica.cadastro.domain.model.MedicalAppointment;
import com.clinica.cadastro.domain.model.Role;
import com.clinica.cadastro.domain.model.User;
import com.clinica.cadastro.domain.repository.AppointmentRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class MedicalAppointmentService {

	private final ProcedureService procedureService;
	
	private final UserService userService;
	
	private final AppointmentRepository appointmentRepository;
	
	public List<MedicalAppointment> findAll() {
		return appointmentRepository.findAll();
	}
	
	public MedicalAppointment findAppointmentById(Long appointmentId) {
		return appointmentRepository.findById(appointmentId)
				.orElseThrow(() -> new EntityNotFoundException(
						String.format("Consulta de id %s não foi encontrado", appointmentId)));
	}
	
	public MedicalAppointment createAppointment(MedicalAppointment appointment) {
		User doctor = userService.findById(appointment.getDoctor().getId());
		User pacient = userService.findById(appointment.getPatient().getId());
		
		if(!doctor.isDoctor()) {
			throw new UserNotDoctorExeption(
					String.format("Usuario de Id %s não esta registrado como medico.", doctor.getId()));
		}
		
		appointment.setDoctor(doctor);
		appointment.setPatient(pacient);
		
		return appointmentRepository.save(appointment);
	}
	
}
